---
name: ShellCheck and Test

on:
  push:
    paths:
      - 'denv'
      - '_denv_entrypoint'
      - 'install'
      - 'uninstall'
      - 'ci/test'
      - 'ci/check'
  workflow_dispatch:
  pull_request:

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        run: ./ci/check

  test:
    name: Test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        runner: [docker, podman]
        include:
          - os: ubuntu-latest
            runner: singularity
            version: 3.8.7
          - os: ubuntu-latest
            runner: apptainer
            version: 1.1.9
          - os: ubuntu-latest
            runner: sylabs
            version: 3.9.9
#          - os: macos-latest
#           runner: docker
    runs-on: ${{matrix.os}}
    steps:
      - uses: actions/checkout@v4
      - name: install singularity
        if: ${{matrix.runner == 'singularity' || matrix.runner == 'apptainer'}}
        run: ./ci/install-singularity-flavor ${{matrix.runner}} ${{matrix.version}}
      - uses: douglascamata/setup-docker-macos-action@v1-alpha
        if: ${{matrix.os == 'macos-latest'}}
      - name: enable debug mode if requested
        if: ${{runner.debug == '1'}}
        run: echo "DENV_DEBUG=1" >> "$GITHUB_ENV"
      - name: Install
        run: sudo ./install
      - name: Test
        env:
          DENV_RUNNER: ${{matrix.runner}}
        run: ./ci/test
